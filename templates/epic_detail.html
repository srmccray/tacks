{% extends "base.html" %}

{% block title %}{{ task.title }} — Epic — Tacks{% endblock %}

{% block content %}
<div id="content-area"
     hx-get="/epics/{{ task.id }}?view={{ view }}"
     hx-trigger="every 2s [document.visibilityState === 'visible']"
     hx-target="this"
     hx-select="#content-area">

<p><a href="/epics">&#8592; Back to epics</a></p>

<h1>{{ task.title }}</h1>

<dl>
  <dt>ID</dt>
  <dd>{{ task.id }}</dd>
  <dt>Status</dt>
  <dd>
    <span class="badge status-{{ task.status }}">
      {%- if task.status == crate::models::Status::Open -%}
        Open
      {%- else if task.status == crate::models::Status::InProgress -%}
        In Progress
      {%- else if task.status == crate::models::Status::Done -%}
        Done
      {%- else -%}
        Blocked
      {%- endif -%}
    </span>
  </dd>
  <dt>Priority</dt>
  <dd class="priority-{{ task.priority }}">P{{ task.priority }}</dd>
  {% if let Some(assignee) = task.assignee.as_deref() %}
  <dt>Assignee</dt>
  <dd>{{ assignee }}</dd>
  {% endif %}
  {% if let Some(desc) = task.description.as_deref() %}
  <dt>Description</dt>
  <dd>{{ desc }}</dd>
  {% endif %}
  {% if !task.tags.is_empty() %}
  <dt>Tags</dt>
  <dd>
    {% for tag in &task.tags %}
      <span class="tag-pill">{{ tag }}</span>
    {% endfor %}
  </dd>
  {% endif %}
  <dt>Progress</dt>
  <dd>{{ children_done }}/{{ children_total }} done</dd>
</dl>

<nav class="view-toggle" style="margin-bottom: 1rem;">
  {% if view == "list" %}
  <strong>List</strong>
  &nbsp;|&nbsp;
  <a href="/epics/{{ task.id }}?view=board">Board</a>
  {% else %}
  <a href="/epics/{{ task.id }}?view=list">List</a>
  &nbsp;|&nbsp;
  <strong>Board</strong>
  {% endif %}
</nav>

<h2>Tasks</h2>

{% if view == "list" %}

{% if children.is_empty() %}
<p>No subtasks yet.</p>
{% else %}
<table>
  <thead>
    <tr>
      <th>ID</th>
      <th>Title</th>
      <th>Status</th>
      <th>Priority</th>
    </tr>
  </thead>
  <tbody>
    {% for child in &children %}
    <tr>
      <td><a href="/tasks/{{ child.id }}" hx-select="unset">{{ child.id }}</a></td>
      <td>{{ child.title }}</td>
      <td>
        <span class="badge status-{{ child.status }}">
          {%- if child.status == crate::models::Status::Open -%}Open
          {%- else if child.status == crate::models::Status::InProgress -%}In Progress
          {%- else if child.status == crate::models::Status::Done -%}Done
          {%- else -%}Blocked{%- endif -%}
        </span>
      </td>
      <td class="priority-{{ child.priority }}">P{{ child.priority }}</td>
    </tr>
    {% endfor %}
  </tbody>
</table>
{% endif %}

{% else %}

{% if children.is_empty() %}
<p>No subtasks yet.</p>
{% else %}
<div class="grid">
  <div>
    <h3>Open</h3>
    {% for child in &children %}
    {%- if child.status == crate::models::Status::Open -%}
    <article>
      <a href="/tasks/{{ child.id }}"
         hx-get="/tasks/{{ child.id }}"
         hx-target="#task-modal"
         hx-select="unset"
         hx-swap="innerHTML">{{ child.title }}</a>
    </article>
    {%- endif -%}
    {% endfor %}
  </div>
  <div>
    <h3>In Progress</h3>
    {% for child in &children %}
    {%- if child.status == crate::models::Status::InProgress -%}
    <article>
      <a href="/tasks/{{ child.id }}"
         hx-get="/tasks/{{ child.id }}"
         hx-target="#task-modal"
         hx-select="unset"
         hx-swap="innerHTML">{{ child.title }}</a>
    </article>
    {%- endif -%}
    {% endfor %}
  </div>
  <div>
    <h3>Blocked</h3>
    {% for child in &children %}
    {%- if child.status == crate::models::Status::Blocked -%}
    <article>
      <a href="/tasks/{{ child.id }}"
         hx-get="/tasks/{{ child.id }}"
         hx-target="#task-modal"
         hx-select="unset"
         hx-swap="innerHTML">{{ child.title }}</a>
    </article>
    {%- endif -%}
    {% endfor %}
  </div>
  <div>
    <h3>Done</h3>
    {% for child in &children %}
    {%- if child.status == crate::models::Status::Done -%}
    <article>
      <a href="/tasks/{{ child.id }}"
         hx-get="/tasks/{{ child.id }}"
         hx-target="#task-modal"
         hx-select="unset"
         hx-swap="innerHTML">{{ child.title }}</a>
    </article>
    {%- endif -%}
    {% endfor %}
  </div>
</div>
{% endif %}

{% endif %}

</div>
{% endblock %}
