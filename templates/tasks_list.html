{% extends "base.html" %}

{% block title %}Tasks â€” Tacks{% endblock %}

{% block content %}
<div id="content-area">

<h1>Tasks</h1>

<form method="get" action="/tasks"
      hx-get="/tasks"
      hx-trigger="change from:select, keyup changed delay:300ms from:input"
      hx-target="#content-area"
      hx-select="#content-area"
      hx-swap="outerHTML"
      hx-push-url="true">
  <div class="grid">
    <select name="status">
      <option value="">All statuses</option>
      <option value="open" {% if status_filter.as_deref() == Some("open") %}selected{% endif %}>Open</option>
      <option value="in_progress" {% if status_filter.as_deref() == Some("in_progress") %}selected{% endif %}>In Progress</option>
      <option value="done" {% if status_filter.as_deref() == Some("done") %}selected{% endif %}>Done</option>
      <option value="blocked" {% if status_filter.as_deref() == Some("blocked") %}selected{% endif %}>Blocked</option>
    </select>
    <select name="priority">
      <option value="">All priorities</option>
      <option value="1" {% if priority_filter.as_deref() == Some("1") %}selected{% endif %}>P1</option>
      <option value="2" {% if priority_filter.as_deref() == Some("2") %}selected{% endif %}>P2</option>
      <option value="3" {% if priority_filter.as_deref() == Some("3") %}selected{% endif %}>P3</option>
    </select>
    <input type="text" name="tag" placeholder="Filter by tag" value="{{ tag_filter.as_deref().unwrap_or_default() }}">
    <noscript><button type="submit">Filter</button></noscript>
  </div>
</form>

<table>
  <thead>
    <tr>
      <th>ID</th>
      <th>Title</th>
      <th>Status</th>
      <th>Priority</th>
      <th>Tags</th>
      <th>Updated</th>
    </tr>
  </thead>
  <tbody hx-get="/tasks{{ poll_query }}"
         hx-trigger="every 2s [document.visibilityState === 'visible']"
         hx-select="tbody"
         hx-swap="outerHTML">
    {% for task in tasks %}
    <tr tabindex="-1" data-href="/tasks/{{ task.id }}">
      <td><a href="/tasks/{{ task.id }}"
             hx-get="/tasks/{{ task.id }}"
             hx-target="#task-modal"
             hx-select="unset"
             hx-swap="innerHTML">{{ task.id }}</a></td>
      <td>{{ task.title }}</td>
      <td><span class="badge status-{{ task.status }}">
        {%- if task.status == crate::models::Status::Open -%}Open
        {%- else if task.status == crate::models::Status::InProgress -%}In Progress
        {%- else if task.status == crate::models::Status::Done -%}Done
        {%- else -%}Blocked{%- endif -%}
      </span></td>
      <td><span class="badge priority-{{ task.priority }}">P{{ task.priority }}</span></td>
      <td>{% for tag in task.tags %}<span class="tag-pill">{{ tag }}</span> {% endfor %}</td>
      <td>{{ task.updated_at.format("%b %d, %Y %H:%M") }}</td>
    </tr>
    {% endfor %}
  </tbody>
</table>
</div>
{% endblock %}
