{% extends "base.html" %}

{% block title %}Tasks â€” Tacks{% endblock %}

{% block content %}
<div id="content-area">

<form method="get" action="/tasks"
      hx-get="/tasks"
      hx-trigger="change from:select, change from:#tag-hidden-input, keyup changed delay:300ms from:input[name='search']"
      hx-target="#content-area"
      hx-select="#content-area"
      hx-swap="outerHTML"
      hx-push-url="true">
  <div class="grid">
    <select name="status">
      <option value="">All statuses</option>
      <option value="open" {% if status_filter.as_deref() == Some("open") %}selected{% endif %}>Open</option>
      <option value="in_progress" {% if status_filter.as_deref() == Some("in_progress") %}selected{% endif %}>In Progress</option>
      <option value="done" {% if status_filter.as_deref() == Some("done") %}selected{% endif %}>Done</option>
      <option value="blocked" {% if status_filter.as_deref() == Some("blocked") %}selected{% endif %}>Blocked</option>
    </select>
    <select name="priority">
      <option value="">All priorities</option>
      <option value="1" {% if priority_filter.as_deref() == Some("1") %}selected{% endif %}>P1</option>
      <option value="2" {% if priority_filter.as_deref() == Some("2") %}selected{% endif %}>P2</option>
      <option value="3" {% if priority_filter.as_deref() == Some("3") %}selected{% endif %}>P3</option>
    </select>
    <div class="tag-autocomplete">
      {% if tag_filter.is_some() %}
      <span class="filter-tag-pill" id="active-tag-pill">
        <span class="filter-tag-pill-text">{{ tag_filter.as_deref().unwrap_or_default() }}</span>
        <button class="filter-tag-pill-remove" type="button" aria-label="Remove tag filter">&times;</button>
      </span>
      {% else %}
      <span class="filter-tag-pill" id="active-tag-pill" style="display:none">
        <span class="filter-tag-pill-text"></span>
        <button class="filter-tag-pill-remove" type="button" aria-label="Remove tag filter">&times;</button>
      </span>
      {% endif %}
      <input type="text" class="tag-text-input" placeholder="Filter by tag" autocomplete="off"
             {% if tag_filter.is_some() %}style="display:none"{% endif %}>
      <input type="hidden" name="tag" value="{{ tag_filter.as_deref().unwrap_or_default() }}" id="tag-hidden-input">
      <ul class="tag-suggestions" id="tag-suggestions"></ul>
    </div>
    <input type="text" name="search" placeholder="Search titles..." value="{{ search_filter.as_deref().unwrap_or_default() }}">
    <noscript><button type="submit">Filter</button></noscript>
  </div>
</form>

<table>
  <thead>
    <tr>
      <th>ID</th>
      <th>Title</th>
      <th>Status</th>
      <th>Priority</th>
      <th>Tags</th>
      <th>Updated</th>
    </tr>
  </thead>
  <tbody hx-get="/tasks{{ poll_query }}"
         hx-trigger="every 2s [document.visibilityState === 'visible']"
         hx-select="tbody"
         hx-swap="outerHTML">
    {% for row in tasks %}
    <tr tabindex="-1" data-href="/tasks/{{ row.task.id }}">
      <td><a href="/tasks/{{ row.task.id }}"
             hx-get="/tasks/{{ row.task.id }}"
             hx-target="#task-modal"
             hx-select="unset"
             hx-swap="innerHTML">{{ row.task.id }}</a></td>
      <td>
        <span data-editable data-field="title" data-task-id="{{ row.task.id }}">{{ row.task.title }}</span>
        {% if let (Some(pid), Some(ptitle)) = (row.parent_id.as_deref(), row.parent_title.as_deref()) %}
        <a href="/epics/{{ pid }}" class="epic-badge">{{ pid }}: {{ ptitle }}</a>
        {% endif %}
      </td>
      <td data-editable data-field="status" data-task-id="{{ row.task.id }}"><span class="badge status-{{ row.task.status }}">
        {%- if row.task.status == crate::models::Status::Open -%}Open
        {%- else if row.task.status == crate::models::Status::InProgress -%}In Progress
        {%- else if row.task.status == crate::models::Status::Done -%}Done
        {%- else -%}Blocked{%- endif -%}
      </span></td>
      <td data-editable data-field="priority" data-task-id="{{ row.task.id }}"><span class="badge priority-{{ row.task.priority }}">P{{ row.task.priority }}</span></td>
      <td data-editable data-field="tags" data-task-id="{{ row.task.id }}">{% for tag in &row.task.tags %}<span class="tag-pill">{{ tag }}</span> {% endfor %}</td>
      <td class="col-updated">{{ row.task.updated_at.format("%b %d %H:%M") }}</td>
    </tr>
    {% endfor %}
  </tbody>
</table>
</div>
{% endblock %}
